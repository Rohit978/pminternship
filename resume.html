<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Builder - ML Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .ai-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            width: 16px;
            height: 16px;
            animation: spin 0.6s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .resume-container {
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-input {
             width: 100%;
             padding: 0.75rem 1rem;
             border-width: 1px;
             border-color: #d1d5db; /* gray-300 */
             border-radius: 0.5rem; /* rounded-lg */
             transition: all 0.2s ease-in-out;
        }

        .form-input.border-red-500 {
             border-width: 2px; /* Make error border stand out */
        }
        
        .error-text {
            color: #ef4444; /* red-500 */
            font-size: 0.75rem; /* text-xs */
            margin-top: 0.25rem; /* mt-1 */
        }

    </style>
</head>
<body class="bg-gray-50">
    
    <header class="bg-white border-b-4 border-gray-900 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-gray-900">AI Resume Builder</h1>
                    <p class="text-gray-600 mt-1">Machine Learning Powered • Professional Templates</p>
                </div>
                <div id="ml-status" class="flex items-center gap-2 bg-green-100 px-4 py-2 rounded-full">
                    <div class="w-2 h-2 bg-green-500 rounded-full ai-badge"></div>
                    <span class="text-sm font-medium text-green-700">ML Ready</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <div class="mb-10">
            <div class="relative">
                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded-full bg-gray-200">
                    <div id="progress" class="gradient-bg transition-all duration-500 ease-out" style="width: 20%"></div>
                </div>
                <div class="flex justify-between text-xs font-semibold text-gray-600">
                    <span class="step-label active">Personal</span>
                    <span class="step-label">Education</span>
                    <span class="step-label">Projects</span>
                    <span class="step-label">Skills</span>
                    <span class="step-label">Preview</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="p-8 lg:p-12">
                
                <div id="step1" class="form-step slide-in">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Personal Information</h2>
                        <p class="text-gray-600">Let's start with your basic details</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Full Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="fullName" 
                                   class="form-input"
                                   placeholder="John Doe" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Professional Title <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="text" id="title" 
                                       class="form-input w-full"
                                       placeholder="Software Engineer | AI Specialist" required>
                                <button type="button" onclick="suggestTitle()" 
                                        class="gradient-bg text-white px-3 py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition flex-shrink-0">
                                    <i class="fas fa-lightbulb"></i> Suggest
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Email Address <span class="text-red-500">*</span>
                            </label>
                            <input type="email" id="email" 
                                   class="form-input"
                                   placeholder="john@example.com" required>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Phone Number <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" id="phone" 
                                   class="form-input"
                                   placeholder="+1 (555) 123-4567" required>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                LinkedIn Profile
                            </label>
                            <input type="url" id="linkedin" 
                                   class="form-input"
                                   placeholder="linkedin.com/in/johndoe">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                GitHub Profile
                            </label>
                            <input type="url" id="github" 
                                   class="form-input"
                                   placeholder="github.com/johndoe">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Portfolio Website
                            </label>
                            <input type="url" id="portfolio" 
                                   class="form-input"
                                   placeholder="johndoe.com">
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <label class="block text-sm font-semibold text-gray-700">
                                Professional Summary
                            </label>
                            <button type="button" onclick="generateSummary()" 
                                    class="gradient-bg text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition flex items-center gap-2">
                                <i class="fas fa-magic"></i> AI Generate
                            </button>
                        </div>
                        <textarea id="summary" rows="5" 
                                  class="form-input"
                                  placeholder="A compelling professional summary highlighting your expertise..."></textarea>
                    </div>
                </div>

                <div id="step2" class="form-step hidden">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Education Background</h2>
                        <p class="text-gray-600">Add your academic qualifications</p>
                    </div>

                    <div id="educationList" class="space-y-6">
                        </div>

                    <button type="button" onclick="addEducation()" 
                            class="mt-6 text-indigo-600 hover:text-indigo-800 font-semibold flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> Add Education
                    </button>
                </div>

                <div id="step3" class="form-step hidden">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Projects & Experience</h2>
                        <p class="text-gray-600">Showcase your work and achievements</p>
                    </div>

                    <div id="projectList" class="space-y-6">
                        </div>

                    <button type="button" onclick="addProject()" 
                            class="mt-6 text-indigo-600 hover:text-indigo-800 font-semibold flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> Add Project
                    </button>
                </div>

                <div id="step4" class="form-step hidden">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Skills & Expertise</h2>
                        <p class="text-gray-600">List your technical and professional skills</p>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <label class="block text-sm font-semibold text-gray-700">
                                    Technical Skills
                                </label>
                                <button type="button" onclick="suggestSkills()" 
                                        class="gradient-bg text-white px-3 py-1 rounded-lg text-xs font-semibold hover:opacity-90 transition flex items-center gap-2">
                                    <i class="fas fa-lightbulb"></i> AI Suggest
                                </button>
                            </div>
                            <textarea id="techSkills" rows="4" 
                                      class="form-input"
                                      placeholder="Python, JavaScript, Machine Learning, TensorFlow, React.js..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">Separate skills with commas</p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Certifications
                            </label>
                            <textarea id="certifications" rows="3" 
                                      class="form-input"
                                      placeholder="AWS Certified Developer&#10;Google Cloud Professional"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Achievements & Awards
                            </label>
                            <textarea id="achievements" rows="3" 
                                      class="form-input"
                                      placeholder="Top 10% in national coding competition&#10;Published research paper in AI conference"></textarea>
                        </div>
                    </div>
                </div>

                <div id="step5" class="form-step hidden">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Resume Preview</h2>
                        <p class="text-gray-600">Review and download your professional resume</p>
                    </div>

                    <div id="aiFeedbackBox" class="mb-6 p-6 bg-gray-50 rounded-xl border border-gray-200 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-microchip text-indigo-500"></i> AI Analysis & Feedback
                        </h3>
                        <ul id="aiFeedbackList" class="list-disc list-inside space-y-2 text-sm">
                            </ul>
                    </div>

                    <div id="resumePreview" class="resume-container rounded-xl p-8 mb-6 border border-gray-200">
                        </div>

                    <div class="flex gap-4 justify-center">
                        <button type="button" onclick="regenerateResume()" 
                                class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i> Regenerate
                        </button>
                        <button type="button" onclick="downloadPDF()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                </div>

            </div>

            <div class="bg-gray-50 px-8 lg:px-12 py-6 flex justify-between border-t">
                <button type="button" id="prevBtn" onclick="previousStep()" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <i class="fas fa-arrow-left mr-2"></i> Previous
                </button>
                <button type="button" id="nextBtn" onclick="nextStep()" 
                        class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                    Next <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </main>

    <script>
        // Global state
        let currentStep = 1;
        const totalSteps = 5;
        let mlModel = null;

        // ML Training Data
        const trainingData = {
            summaries: {
                software: [
                    "Innovative {title} with expertise in {skills}. Proven track record of building scalable applications and solving complex technical challenges. Passionate about leveraging cutting-edge technologies to drive business value and user satisfaction.",
                    "Results-driven {title} specializing in {skills}. Strong background in full-stack development with demonstrated ability to lead projects from conception to deployment. Committed to writing clean, maintainable code and continuous learning.",
                    "Dynamic {title} with deep knowledge of {skills}. Experience designing and implementing robust software solutions for diverse business needs. Excel in collaborative environments and thrive on solving challenging problems."
                ],
                data: [
                    "Analytical {title} with proficiency in {skills}. Skilled at transforming raw data into actionable insights using advanced statistical methods and machine learning algorithms. Passionate about data-driven decision making.",
                    "Detail-oriented {title} specializing in {skills}. Extensive experience with data pipeline development, predictive modeling, and business intelligence. Strong communicator able to present complex findings to non-technical stakeholders.",
                    "Results-focused {title} with expertise in {skills}. Track record of building data products that drive business growth. Proficient in statistical analysis, machine learning, and data visualization."
                ],
                creative: [
                    "Creative {title} with mastery of {skills}. Portfolio showcases innovative design solutions that balance aesthetics with functionality. Passionate about creating user experiences that delight and engage.",
                    "Versatile {title} specializing in {skills}. Strong eye for detail and deep understanding of design principles. Experience collaborating with cross-functional teams to bring visions to life.",
                    "Innovative {title} skilled in {skills}. Proven ability to translate business requirements into compelling visual narratives. Always exploring new design trends and technologies."
                ]
            },
            
            actionVerbs: [
                'Architected', 'Engineered', 'Developed', 'Implemented', 'Designed', 'Built',
                'Created', 'Launched', 'Deployed', 'Optimized', 'Streamlined', 'Enhanced',
                'Automated', 'Integrated', 'Spearheaded', 'Led', 'Managed', 'Coordinated',
                'Delivered', 'Achieved', 'Improved', 'Reduced', 'Increased', 'Transformed'
            ],
            
            impactMetrics: [
                'improving performance by {num}%',
                'reducing load time by {num}%',
                'increasing efficiency by {num}%',
                'achieving {num}% code coverage',
                'handling {num}K+ concurrent users',
                'processing {num}M+ records',
                'reducing costs by ${num}K',
                'boosting user engagement by {num}%'
            ],
            
            skillsDatabase: {
                'software engineer': ['JavaScript', 'Python', 'React', 'Node.js', 'AWS', 'Docker', 'Git', 'SQL', 'REST APIs', 'TypeScript'],
                'data scientist': ['Python', 'R', 'TensorFlow', 'PyTorch', 'SQL', 'Pandas', 'NumPy', 'Scikit-learn', 'Tableau', 'Statistics'],
                'ai engineer': ['Python', 'TensorFlow', 'PyTorch', 'Deep Learning', 'NLP', 'Computer Vision', 'Keras', 'OpenCV', 'Neural Networks', 'ML Algorithms'],
                'web developer': ['HTML', 'CSS', 'JavaScript', 'React', 'Vue.js', 'Angular', 'Node.js', 'MongoDB', 'REST APIs', 'Responsive Design'],
                'mobile developer': ['React Native', 'Flutter', 'Swift', 'Kotlin', 'iOS', 'Android', 'Firebase', 'Mobile UI/UX', 'App Store', 'Play Store']
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeML();
            addEducation();
            addProject();
            updateNavigation();
        });

        // ML Initialization
        async function initializeML() {
            try {
                // Simulated ML model initialization
                await new Promise(resolve => setTimeout(resolve, 1000));
                mlModel = { ready: true };
                console.log('ML Model initialized');
            } catch (error) {
                console.error('ML initialization error:', error);
            }
        }

        // Navigation
        function nextStep() {
            if (validateStep(currentStep)) {
                if (currentStep < totalSteps) {
                    if (currentStep === 4) {
                        generateResume(); // This now calls runResumeAnalysis() internally
                    }
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgress();
            }
        }

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach((el, index) => {
                el.classList.toggle('hidden', index + 1 !== step);
                if (index + 1 === step) {
                    el.classList.add('slide-in');
                }
            });
            updateNavigation();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progress').style.width = progress + '%';
            
            document.querySelectorAll('.step-label').forEach((label, index) => {
                label.classList.toggle('active', index + 1 <= currentStep);
                label.style.color = index + 1 <= currentStep ? '#667eea' : '#6b7280';
                label.style.fontWeight = index + 1 === currentStep ? '700' : '600';
            });
        }

        function updateNavigation() {
            document.getElementById('prevBtn').disabled = currentStep === 1;
            const nextBtn = document.getElementById('nextBtn');
            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'block';
            }
        }

        // --- Enhanced Validation ---
        function clearErrors() {
            document.querySelectorAll('.border-red-500').forEach(el => {
                el.classList.remove('border-red-500', 'border-2');
                el.classList.add('border-gray-300');
            });
            document.querySelectorAll('.error-text').forEach(el => el.remove());
        }

        function showError(element, message) {
            element.classList.remove('border-gray-300');
            element.classList.add('border-red-500', 'border-2');
            const error = document.createElement('p');
            error.className = 'error-text';
            error.textContent = message;
            element.parentNode.appendChild(error);
        }

        function validateStep(step) {
            clearErrors();
            let isValid = true;
            
            if (step === 1) {
                const required = {
                    fullName: 'Full Name',
                    title: 'Professional Title',
                    email: 'Email Address',
                    phone: 'Phone Number'
                };
                for (let [id, name] of Object.entries(required)) {
                    const el = document.getElementById(id);
                    if (!el.value.trim()) {
                        showError(el, `${name} is required.`);
                        isValid = false;
                    }
                }
            }
            
            if (step === 2) {
                document.querySelectorAll('.education-item').forEach((item) => {
                    const degree = item.querySelector('.edu-degree');
                    const institution = item.querySelector('.edu-institution');
                    const year = item.querySelector('.edu-year');
                    
                    if (!degree.value.trim()) {
                        showError(degree, 'Degree is required.');
                        isValid = false;
                    }
                    if (!institution.value.trim()) {
                        showError(institution, 'Institution is required.');
                        isValid = false;
                    }
                     if (!year.value.trim()) {
                        showError(year, 'Year is required.');
                        isValid = false;
                    }
                });
            }
            
            if (step === 3) {
                 document.querySelectorAll('.project-item').forEach((item) => {
                    const name = item.querySelector('.proj-name');
                    if (!name.value.trim()) {
                        showError(name, 'Project Name is required.');
                        isValid = false;
                    }
                });
            }
            
            return isValid;
        }

        // Education Management
        function addEducation() {
            const template = `
                <div class="education-item border border-gray-200 rounded-xl p-6 relative">
                    <button type="button" onclick="removeItem(this, '.education-item')" 
                            class="absolute top-4 right-4 text-red-500 hover:text-red-700 text-xl font-bold">
                        &times;
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Degree *</label>
                            <input type="text" class="edu-degree form-input"
                                   placeholder="Bachelor of Science" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Field of Study</label>
                            <input type="text" class="edu-field form-input"
                                   placeholder="Computer Science">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Institution *</label>
                            <input type="text" class="edu-institution form-input"
                                   placeholder="University Name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Year *</label>
                            <input type="text" class="edu-year form-input"
                                   placeholder="2020 - 2024" required>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('educationList').insertAdjacentHTML('beforeend', template);
        }

        // Project Management
        function addProject() {
            const template = `
                <div class="project-item border border-gray-200 rounded-xl p-6 relative">
                    <button type="button" onclick="removeItem(this, '.project-item')" 
                            class="absolute top-4 right-4 text-red-500 hover:text-red-700 text-xl font-bold">
                        &times;
                    </button>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Project Name *</label>
                                <input type="text" class="proj-name form-input"
                                       placeholder="AI Chatbot Application" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                                <input type="text" class="proj-role form-input"
                                       placeholder="Lead Developer">
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Description & Achievements</label>
                                <button type="button" onclick="enhanceDescription(this)" 
                                        class="gradient-bg text-white px-3 py-1 rounded-lg text-xs font-semibold hover:opacity-90 transition flex items-center gap-1">
                                    <i class="fas fa-wand-magic-sparkles"></i> Enhance
                                </button>
                            </div>
                            <textarea class="proj-desc form-input" rows="4"
                                      placeholder="Describe your contributions, technologies used, and impact..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Technologies</label>
                            <input type="text" class="proj-tech form-input"
                                   placeholder="Python, TensorFlow, React, Flask">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('projectList').insertAdjacentHTML('beforeend', template);
        }

        // Remove item
        function removeItem(button, selector) {
            const items = document.querySelectorAll(selector);
            if (items.length > 1) {
                button.closest(selector).remove();
            } else {
                alert('You must keep at least one entry');
            }
        }

        // --- AI/ML Functions ---

        // ML-powered Skill Suggestions
        async function suggestSkills() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div> Analyzing...';

            try {
                await new Promise(resolve => setTimeout(resolve, 1000));

                const title = document.getElementById('title').value.toLowerCase();
                const projects = Array.from(document.querySelectorAll('.proj-tech')).map(t => t.value).join(' ').toLowerCase();
                
                let suggestedSkills = [];
                
                // Match skills based on title and projects
                for (let [role, skills] of Object.entries(trainingData.skillsDatabase)) {
                    if (title.includes(role) || projects.includes(role)) {
                        suggestedSkills.push(...skills);
                    }
                }
                
                // Add common skills
                suggestedSkills.push('Git', 'Agile', 'Problem Solving', 'Team Collaboration');
                
                // Get current skills, merge, and remove duplicates
                const currentSkills = document.getElementById('techSkills').value
                    .split(',')
                    .map(s => s.trim())
                    .filter(s => s);
                    
                const allSkills = [...new Set([...currentSkills, ...suggestedSkills])];
                
                document.getElementById('techSkills').value = allSkills.join(', ');
                
            } catch (error) {
                console.error('Error:', error);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
        
        // ML-powered Summary Generation
        async function generateSummary() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div> Generating...';

            try {
                await new Promise(resolve => setTimeout(resolve, 1500));

                const title = document.getElementById('title').value.toLowerCase() || 'professional';
                // Get skills from Step 4, even if we are on Step 1
                const skills = document.getElementById('techSkills').value || 'various technologies';
                
                // Classify category
                let category = 'creative';
                if (title.includes('engineer') || title.includes('developer') || title.includes('software')) {
                    category = 'software';
                } else if (title.includes('data') || title.includes('analyst') || title.includes('scientist')) {
                    category = 'data';
                }
                
                // Select random template
                const templates = trainingData.summaries[category];
                const template = templates[Math.floor(Math.random() * templates.length)];
                
                // Fill template
                const topSkills = skills.split(',').slice(0, 4).map(s => s.trim()).join(', ');
                const summary = template
                    .replace('{title}', document.getElementById('title').value || 'Professional')
                    .replace('{skills}', topSkills);
                
                document.getElementById('summary').value = summary;
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate summary. Please try again.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }

        // ML-powered Description Enhancement
        async function enhanceDescription(button) {
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div>';

            try {
                await new Promise(resolve => setTimeout(resolve, 1200));

                const projectDiv = button.closest('.project-item');
                const textarea = projectDiv.querySelector('.proj-desc');
                let text = textarea.value.trim();
                
                if (!text) {
                    alert('Please enter a description first');
                    return;
                }

                // Parse into points
                const points = text.split('\n').map(p => p.replace(/^[•\-\*]\s*/, '').trim()).filter(p => p);
                const enhanced = [];

                for (let point of points) {
                    let originalPoint = point;
                    
                    // Add action verb
                    let hasVerb = trainingData.actionVerbs.some(v => point.toLowerCase().startsWith(v.toLowerCase()));
                    if (!hasVerb) {
                        const verb = trainingData.actionVerbs[Math.floor(Math.random() * trainingData.actionVerbs.length)];
                        point = verb + ' ' + point.charAt(0).toLowerCase() + point.slice(1);
                    }
                    
                    // Add metrics if missing
                    if (!point.match(/\d+%|\d+[KM]/)) {
                        const metric = trainingData.impactMetrics[Math.floor(Math.random() * trainingData.impactMetrics.length)];
                        const num = Math.floor(Math.random() * 50) + 20;
                        point += ', ' + metric.replace('{num}', num);
                    }
                    
                    enhanced.push('• ' + point);
                }

                textarea.value = enhanced.join('\n');
            } catch (error) {
                console.error('Error:', error);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }

        // NEW: ML-powered Title Suggestion
        async function suggestTitle() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div>';

            try {
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Get all skills and project text from other steps
                const skillsText = document.getElementById('techSkills').value.toLowerCase();
                const projectTech = Array.from(document.querySelectorAll('.proj-tech')).map(t => t.value).join(' ').toLowerCase();
                
                const allText = skillsText + ' ' + projectTech;
                
                let suggestions = {};
                let bestMatch = 'Software Developer'; // Default
                let maxScore = 0;

                // "Analyze" the text against our skillsDatabase
                for (let [role, skills] of Object.entries(trainingData.skillsDatabase)) {
                    let score = 0;
                    skills.forEach(skill => {
                        if (allText.includes(skill.toLowerCase())) {
                            score++;
                        }
                    });
                    suggestions[role] = score;
                    
                    if (score > maxScore) {
                        maxScore = score;
                        // Capitalize the role nicely
                        bestMatch = role.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    }
                }
                
                console.log("Title Scores:", suggestions);

                if (maxScore > 0) {
                    document.getElementById('title').value = bestMatch;
                } else {
                    alert("Couldn't find a good match. Try adding some skills in Step 4 first!");
                }

            } catch (error) {
                console.error('Title suggestion error:', error);
            } finally {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
        
        // NEW: AI-powered Resume Analysis
        function runResumeAnalysis() {
            const feedbackList = document.getElementById('aiFeedbackList');
            const feedbackBox = document.getElementById('aiFeedbackBox');
            feedbackList.innerHTML = ''; // Clear old feedback
            
            let feedbackItems = [];

            // Rule 1: Check for professional summary
            const summary = document.getElementById('summary').value;
            if (!summary) {
                feedbackItems.push({ text: 'Missing a Professional Summary. Add one to give recruiters a quick overview.', type: 'error' });
            } else if (summary.split(' ').length < 25) {
                feedbackItems.push({ text: 'Your Professional Summary is very short. Consider expanding it to 3-4 sentences.', type: 'warning' });
            } else {
                feedbackItems.push({ text: 'Great Professional Summary!', type: 'success' });
            }

            // Rule 2: Check for metrics in projects
            const projectDescs = Array.from(document.querySelectorAll('.proj-desc')).map(d => d.value);
            const hasMetrics = projectDescs.some(desc => desc.match(/\d+%|\d+[KM]|\$\d+/));
            if (!hasMetrics) {
                feedbackItems.push({ text: 'Your project descriptions are missing quantifiable metrics (e.g., "improved by 20%", "handled 10K users"). Add metrics to show impact.', type: 'error' });
            } else {
                feedbackItems.push({ text: 'Awesome! Your projects include quantifiable metrics.', type: 'success' });
            }
            
            // Rule 3: Check for action verbs
            const hasActionVerbs = projectDescs.some(desc => 
                trainingData.actionVerbs.some(verb => desc.toLowerCase().includes(verb.toLowerCase()))
            );
            if (!hasActionVerbs) {
                 feedbackItems.push({ text: 'Start your project bullet points with strong action verbs (e.g., "Developed", "Architected", "Optimized").', type: 'warning' });
            }

            // Rule 4: Check skills count
            const skills = document.getElementById('techSkills').value.split(',').filter(s => s.trim());
            if (skills.length < 5) {
                feedbackItems.push({ text: 'Your skills list is short. Try to list at least 5-10 key technical skills.', type: 'warning' });
            } else {
                feedbackItems.push({ text: 'Good list of technical skills.', type: 'success' });
            }
            
            // Display feedback
            feedbackItems.forEach(item => {
                let icon = '';
                if (item.type === 'success') icon = '<i class="fas fa-check-circle text-green-500 mr-2"></i>';
                if (item.type === 'warning') icon = '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>';
                if (item.type === 'error') icon = '<i class="fas fa-times-circle text-red-500 mr-2"></i>';
                
                const li = document.createElement('li');
                li.innerHTML = `${icon} ${item.text}`;
                feedbackList.appendChild(li);
            });

            feedbackBox.classList.remove('hidden');
        }

        // --- Resume Generation & PDF ---

        // Generate Resume HTML
        function generateResume() {
            const preview = document.getElementById('resumePreview');
            preview.innerHTML = '<div class="text-center py-20"><div class="spinner mx-auto mb-4" style="width: 40px; height: 40px; border-width: 4px; border-top-color: #667eea;"></div><p class="text-gray-600 text-lg">Generating your professional resume...</p></div>';
            
            // UPDATED: Call the analysis function
            runResumeAnalysis(); 
            
            setTimeout(() => {
                preview.innerHTML = buildResumeHTML();
            }, 1500);
        }

        function formatLink(url, text) {
            if (!url) return '';
            let cleanUrl = url.trim();
            if (!cleanUrl.startsWith('http://') && !cleanUrl.startsWith('https://')) {
                cleanUrl = 'https://' + cleanUrl;
            }
            const displayText = text || url.replace(/^https?:\/\//, '').replace(/\/$/, '');
            return `<a href="${cleanUrl}" target="_blank" style="color: #4b5563; text-decoration: none; word-break: break-all;">${displayText}</a>`;
        }

        function buildResumeHTML() {
            // Collect data
            const data = {
                name: document.getElementById('fullName').value,
                title: document.getElementById('title').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                linkedin: document.getElementById('linkedin').value,
                github: document.getElementById('github').value,
                portfolio: document.getElementById('portfolio').value,
                summary: document.getElementById('summary').value,
                education: [],
                projects: [],
                skills: document.getElementById('techSkills').value.split(',').map(s => s.trim()).filter(s => s),
                certifications: document.getElementById('certifications').value.split('\n').filter(s => s.trim()),
                achievements: document.getElementById('achievements').value.split('\n').filter(s => s.trim())
            };

            // Collect education
            document.querySelectorAll('.education-item').forEach(item => {
                const degree = item.querySelector('.edu-degree').value;
                if (degree) {
                    data.education.push({
                        degree: degree,
                        field: item.querySelector('.edu-field').value,
                        institution: item.querySelector('.edu-institution').value,
                        year: item.querySelector('.edu-year').value
                    });
                }
            });

            // Collect projects
            document.querySelectorAll('.project-item').forEach(item => {
                const name = item.querySelector('.proj-name').value;
                if (name) {
                    data.projects.push({
                        name: name,
                        role: item.querySelector('.proj-role').value,
                        description: item.querySelector('.proj-desc').value.replace(/\n/g, '<br>'), // Preserve line breaks
                        tech: item.querySelector('.proj-tech').value
                    });
                }
            });

            // Build HTML (Styling is inline for PDF generation)
            return `
                <div style="max-width: 8.5in; margin: 0 auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; color: #333; line-height: 1.5;">
                    
                    <div style="border-bottom: 4px solid #111827; padding: 2rem 2rem 1rem 2rem;">
                        <h1 style="font-size: 2.5rem; font-weight: bold; color: #111827; margin-bottom: 0.25rem; text-transform: uppercase;">${data.name}</h1>
                        <p style="font-size: 1.125rem; color: #374151; margin-bottom: 0.75rem;">${data.title}</p>
                        <div style="font-size: 0.875rem; color: #4b5563;">
                            <p style="margin-bottom: 0.25rem;">
                                <a href="mailto:${data.email}" style="color: #4b5563; text-decoration: none;">${data.email}</a> | 
                                <a href="tel:${data.phone}" style="color: #4b5563; text-decoration: none;">${data.phone}</a>
                            </p>
                            <p>
                                ${data.linkedin ? formatLink(data.linkedin, 'LinkedIn') : ''}
                                ${data.github ? (data.linkedin ? ' | ' : '') + formatLink(data.github, 'GitHub') : ''}
                                ${data.portfolio ? ((data.linkedin || data.github) ? ' | ' : '') + formatLink(data.portfolio, 'Portfolio') : ''}
                            </p>
                        </div>
                    </div>

                    <div style="padding: 1.5rem 2rem;">
                        
                        ${data.summary ? `
                        <section style="margin-bottom: 1.25rem;">
                            <h2 style="font-size: 1.125rem; font-weight: bold; color: #111827; border-bottom: 2px solid #d1d5db; padding-bottom: 0.25rem; margin-bottom: 0.5rem;">PROFESSIONAL SUMMARY</h2>
                            <p style="font-size: 0.875rem; color: #1f2937; text-align: justify;">${data.summary}</p>
                        </section>
                        ` : ''}

                        ${data.education.length > 0 ? `
                        <section style="margin-bottom: 1.25rem;">
                            <h2 style="font-size: 1.125rem; font-weight: bold; color: #111827; border-bottom: 2px solid #d1d5db; padding-bottom: 0.25rem; margin-bottom: 0.5rem;">EDUCATION</h2>
                            ${data.education.map(edu => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                                    <div>
                                        <h3 style="font-weight: bold; color: #111827; font-size: 0.875rem;">${edu.degree}</h3>
                                        ${edu.field ? `<p style="font-size: 0.875rem; color: #374151;">${edu.field}</p>` : ''}
                                        <p style="font-size: 0.875rem; color: #374151;">${edu.institution}</p>
                                    </div>
                                    <p style="font-size: 0.875rem; color: #374151; font-weight: 600; white-space: nowrap; padding-left: 1rem;">${edu.year}</p>
                                </div>
                            `).join('')}
                        </section>
                        ` : ''}

                        ${data.skills.length > 0 ? `
                        <section style="margin-bottom: 1.25rem;">
                            <h2 style="font-size: 1.125rem; font-weight: bold; color: #111827; border-bottom: 2px solid #d1d5db; padding-bottom: 0.25rem; margin-bottom: 0.5rem;">TECHNICAL SKILLS</h2>
                            <div style="font-size: 0.875rem; color: #1f2937;">
                                <p><span style="font-weight: bold; color: #111827;">Skills:</span> ${data.skills.join(', ')}</p>
                            </div>
                        </section>
                        ` : ''}

                        ${data.projects.length > 0 ? `
                        <section style="margin-bottom: 1.25rem;">
                            <h2 style="font-size: 1.125rem; font-weight: bold; color: #111827; border-bottom: 2px solid #d1d5db; padding-bottom: 0.25rem; margin-bottom: 0.5rem;">PROJECTS & TECHNICAL EXPERIENCE</h2>
                            ${data.projects.map(proj => `
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                        <h3 style="font-weight: bold; color: #111827; font-size: 0.875rem;">${proj.name}</h3>
                                    </div>
                                    ${proj.role ? `<p style="font-size: 0.875rem; color: #374151; font-style: italic; margin-bottom: 0.25rem;">${proj.role}</p>` : ''}
                                    <div style="font-size: 0.875rem; color: #1f2937; margin-bottom: 0.25rem; white-space: pre-wrap; word-break: break-word;">${proj.description}</div>
                                    ${proj.tech ? `<p style="font-size: 0.875rem; color: #4b5563; margin-top: 0.25rem;"><span style="font-weight: 600;">Technologies:</span> ${proj.tech}</p>` : ''}
                                </div>
                            `).join('')}
                        </section>
                        ` : ''}

                        ${data.certifications.length > 0 ? `
                        <section style="margin-bottom: 1.25rem;">
                            <h2 style="font-size: 1.125rem; font-weight: bold; color: #111827; border-bottom: 2px solid #d1d5db; padding-bottom: 0.25rem; margin-bottom: 0.5rem;">CERTIFICATIONS</h2>
                            <div style="font-size: 0.875rem; color: #1f2937;">
                                <ul style="list-style-position: inside; padding-left: 0; margin: 0;">
                                    ${data.certifications.map(cert => `<li style="margin-bottom: 0.25rem;">${cert}</li>`).join('')}
                                </ul>
                            </div>
                        </section>
                        ` : ''}

                        ${data.achievements.length > 0 ? `
                        <section style="margin-bottom: 1.25rem;">
                            <h2 style="font-size: 1.125rem; font-weight: bold; color: #111827; border-bottom: 2px solid #d1d5db; padding-bottom: 0.25rem; margin-bottom: 0.5rem;">ACHIEVEMENTS & LEADERSHIP</h2>
                            <div style="font-size: 0.875rem; color: #1f2937;">
                                <ul style="list-style-position: inside; padding-left: 0; margin: 0;">
                                    ${data.achievements.map(ach => `<li style="margin-bottom: 0.25rem;">${ach}</li>`).join('')}
                                </ul>
                            </div>
                        </section>
                        ` : ''}

                    </div>
                </div>
            `;
        }

        function regenerateResume() {
            generateResume();
        }

        // Download PDF
        function downloadPDF() {
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="spinner"></div> Generating PDF...';

            const preview = document.getElementById('resumePreview');
            
            html2canvas(preview, { 
                scale: 2, // Use 2 for better performance vs. 3
                useCORS: true,
                logging: false 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'a4'
                });
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                const filename = document.getElementById('fullName').value.replace(/\s+/g, '_') + '_Resume.pdf';
                pdf.save(filename);
                
                button.disabled = false;
                button.innerHTML = originalHTML;
            }).catch(error => {
                console.error('PDF generation error:', error);
                alert('Failed to generate PDF. Please try again.');
                button.disabled = false;
                button.innerHTML = originalHTML;
            });
        }

    </script>
</body>
</html>